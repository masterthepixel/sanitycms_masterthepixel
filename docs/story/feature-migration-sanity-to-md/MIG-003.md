# MIG-003 — NDJSON → MDX/JSON converter script (idempotent)

Branch: feature/migration/sanity-to-md/mig-003
Priority: High
Estimate: 12–24 hours

## Goal
Provide an idempotent converter that transforms `content-only.ndjson` into MDX/JSON files; includes asset downloading and a pre‑processor to validate/clean NDJSON.

## Acceptance criteria
- `scripts/sanity-to-mdx.js --dry-run` reports counts, lists unmapped blocks, and validates NDJSON
- Script converts a sample set reproducibly and produces `content/posts.json` index

## Developer tasks (developer-ready, assignable)
1. NDJSON pre-processor & validator (2h)
   - Implement `scripts/ndjson-cleaner.js` that fixes common issues (stray commas after `{`, malformed escapes) and validates each line with `JSON.parse`.
   - CLI usage: `node scripts/ndjson-cleaner.js content-only.ndjson --in-place --report`
2. Converter core (4–8h)
   - Implement `scripts/sanity-to-mdx.js`:
     - Read NDJSON (cleaned) and filter `_type == 'post' | 'page'`.
     - Map fields to frontmatter (title, slug, date, excerpt, seo, coverImage, draft).
     - Convert `content[]` (Portable Text) to Markdown/MDX using `@portabletext/to-markdown` (or custom handlers for embeds).
     - Output `.mdx` files to `content/posts/` and `content/pages/`.
3. Asset downloader & URL rewrite (2–4h)
   - Download referenced assets from `assets.json` and post documents to `public/uploads/<type>/<slug>/`.
   - Rewrite image URLs in MDX body and frontmatter to local paths.
4. CLI modes & reporting (1–2h)
   - Support `--dry-run` (no writes), `--report` (summary), `--commit` (apply changes).
   - Produce `report.json` with counts, unmapped block types, missing assets.
5. Tests & sample fixtures (1–2h)
   - Add integration test that converts 5 sample NDJSON entries and asserts output files and `content/posts.json` index.
   - Use fixture path `tests/fixtures/sanity/sample.ndjson` for reproducible tests.

Assignee: @tooling (suggested) — scripts & infra owner

Dev acceptance checklist
- [ ] NDJSON cleaner removes/flags malformed lines
- [ ] Converter handles Portable Text blocks used in repo (report shows unmapped=0 for sample set)
- [ ] Assets downloaded and image URLs rewritten
- [ ] `scripts/sanity-to-mdx.js --dry-run` runs without errors and `--commit` produces files
- [ ] PR merged into epic branch

## Done checklist
- [ ] NDJSON pre-processor implemented and tested
- [ ] Converter script supports dry-run & report
- [ ] Sample posts converted and index produced
- [ ] PR merged into epic branch
